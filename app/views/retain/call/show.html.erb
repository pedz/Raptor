<!-- retain/call/show.html.erb -->

<% @title = "Retain call: #{@pmr.pbc}" %>
<% content_for(:top) do %>
  <table id='pmr-header'>
    <tr>
      <td>
	<span id='queue' class='field-left'>
	  <span id='queue-header' class='field-header'>
	    Queue
	  </span>
	  <span id='queue-spec' class='field'>
	    <%= link_to @call.queue.to_param, @call.queue %>
	  </span>
	</span>
      </td>
      <td>
	<span id='pbc' class='field field-center'>
	  <%= h @pmr.pbc %>
	</span>
      </td>
      <td>
	<span id='pri-sev' class='field-right'>
	  <span id='pri-sev-header' class='field-header'>
	    P/S
	  </span>
	  <span id='pri-sev-spec' class='field'>
	    <%= h @call.priority %> / 
	    <%= h @pmr.severity %>
	  </span>
	</span>
      </td>
    </tr>
    <tr>
      <td>
	<span id='owner' class='field-left'>
	  <span id='owner-header' class='field-header'>
	    Owner
	  </span>
	  <span id='owner-spec' class='field'>
	    <%= h @pmr.owner.name %>
	    <span class='inplace-edit'
		  href='<%= alter_combined_call_path(@call) %>'
		  value='owner_signon'>
	      <%= h @pmr.owner.signon %>
	    </span>
	  </span>
	</span>
      </td>
      <td>
	<span id='customer-name' class='field field-center'>
	  <%= h @call.nls_customer_name %>
	</span>
      </td>
      <td>
	<span id='resolver' class='field-right'>
	  <span id='resolver-header' class='field-header'>
	    Resolver
	  </span>
	  <span id='resolver-spec' class='field'>
	    <%= h @pmr.resolver.name %>
	    <span class='inplace-edit'
		  href='<%= alter_combined_call_path(@call) %>'
		  value='resolver_signon'>
	      <%= h @pmr.resolver.signon %>
	    </span>
	  </span>
	</span>
      </td>
    </tr>
    <tr>
      <td>
	<span id='comp' class='field-left'>
	  <span id='comp-header' class='field-header'>
	    Comp
	  </span>
	  <span id='comp-spec' class='field'>
	    <%= h @pmr.component_id %>
	  </span>
	</span>
      </td>
      <td>
	<span id='comments' class='field field-center'>
	  <%= h @call.comments %>
	</span>
      </td>
      <td>
	<span class='field-right'>
	</span>
      </td>
    </tr>
    <tr>
      <td colspan='3'>
	<span id='click-header'>Click to view:</span>
	<span id='ecpaat-header'  class='click-tag' for='ecpaat-lines'>ECPAAT</span>,
	<span id='scratch-header' class='click-tag' for='scratch-lines'>Scratch Pad</span>,
	<span id='contact-header' class='click-tag' for='contact-lines'>Contact Info</span><br/>
	<span id='ecpaat-lines' class='click-data'>
	  <%= ecpaat_lines(@pmr) %>
	</span>
	<span id='scratch-lines' class='click-data'>
	  <% for sp_line in @pmr.scratch_pad_lines %>
	    <%= show_line(sp_line, 1, signon_user.tz) %>
	  <% end %>
	</span>
	<span id='contact-lines' class='click-data'>
	  <%= h @call.nls_contact_name %><br/>
	  <%= h @call.contact_phone_1 %><br/>
	  <%= h @call.contact_phone_2 %><br/>
	  <a id='mailto'
	     href="#"
	     onclick='Raptor.newUrl("<%= h @pmr.problem_e_mail.strip %>", "PMR <%= @pmr.pbc.upcase %>");'>
	    <%= h @pmr.problem_e_mail %>
	  </a><br/>
	</span>
      </td>
    </tr>
  </table>
<% end %>

<% all_lines = @pmr.alterable_format_lines + @pmr.text_lines %>

<% content_for(:center) do %>
  <div class='even'>
    <% tz = signon_user.tz %>
    <% all_lines.each_with_index do |line, index| %>
      <%= show_line(line, index, tz) %>
    <% end %>
  </div>
<% end %>

<% content_for(:left) do %>
  <table>
  <% all_lines.each_with_index do |line, index| %>
  <%   if line.text_type == :system_inserted %>
  <%     md = Regexp.new(' S5> (SERVICE GIVEN= ([0-9][0-9]))  SG/[0-9]9/').match(line.text) %>
  <%     unless md.nil? || md[2] == "99" %>
    <tr>
      <td>
	&nbsp;
      </td>
      <td>
	<%= "<a href='#line_#{index}'>#{md[1]}</a>" %>
      </td>
    </tr>
  <%     end %>
  <%   end %>
  <%   if line.text_type == :signature %>
  <%     sig_line = Retain::SignatureLine.new(line.text) %>
  <%     unless sig_line.name.nil? || sig_line.stype.nil? %>
    <tr>
      <td colspan='2'>
	<%= "<a href='#line_#{index}'>#{sig_line.name}</a>" %>
      </td>
      <td>
	<%= "<a href='#line_#{index}'>#{sig_line.stype}</a>" %>
      </td>
    </tr>
  <%     end %>
  <%   end %>
  <% end %>
  </table>
<% end %>

<% content_for(:left_tab) do %>
  <div>S<br/>i<br/>g<br/>n<br/>a<br/>t<br/>u<br/>r<br/>e<br/>s</div>
<% end %>

<% content_for(:right_tab) do %>
  <div>P<br/>a<br/>g<br/>e<br/>s<br/></div>
<% end %>

<% content_for(:right) do %>
  <div>
    <% (0 ... (all_lines.length / 16)).each do |page_number| %>
    <%= "<a href='#line_#{page_number * 16}'>Page #{page_number + 2}</a><br/>" %>
    <% end %>
  </div>
<% end %>

<% content_for(:bottom) do %>
  <div>
    <%= button_url("Home", "/") %>
    <%= button_url("Favorites", combined_favorite_queues_path) %>
    <%= button_url("Queue #{@queue.to_param}", combined_queue_path(@queue)) %>
    <%= button_url("QS #{@queue.to_param}", combined_q_path(@queue)) %>
    <%= button_url("PSAR", retain_psar_path) %>
    <%= button_url("Registration", @registration) %>
    <%= button("Update", "Raptor.updateToggle();") %>
    <form id='update-form'>
      <textarea rows="10" cols="72">Action Taken:


Action Plan:

      </textarea>
    </form>
  </div>
<% end %>
